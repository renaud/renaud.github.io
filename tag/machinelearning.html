<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Renaud Richardet - machinelearning</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Renaud Richardet Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Renaud Richardet </a></h1>
                <nav><ul>
                    <li><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/theano-and-cuda.html">Theano and CUDA</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-08-07T00:00:00">
                Published: Thu 07 August 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/renaud-richardet.html">Renaud Richardet</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>. </p>
<p>tags: <a href="/tag/deeplearning.html">deeplearning</a> <a href="/tag/python.html">python</a> <a href="/tag/machinelearning.html">machinelearning</a> </p>
</footer><!-- /.post-info --><h2>Theano on the CPU</h2>
<p>Install Theano with</p>
<div class="highlight"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">theano</span>
</pre></div>


<p>Then try the mandatory MNIST tutorial from http://github.com/lisa-lab/DeepLearningTutorials/blob/master/code/DBN.py</p>
<p>It seems to works (still training), but takes time</p>
<h2>CUDA</h2>
<p>Trying to make things faster</p>
<p>First, which card do I have?</p>
<div class="highlight"><pre><span class="err">$</span><span class="o">&gt;</span> <span class="n">lspci</span>
<span class="p">(</span><span class="n">and</span> <span class="n">search</span> <span class="k">for</span> <span class="n">your</span> <span class="n">card</span> <span class="n">there</span><span class="p">)</span>
<span class="n">GeForce</span> <span class="n">GTX</span> <span class="mi">560</span> <span class="n">Ti</span>
</pre></div>


<p>I found some info there:</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//www.nvidia.com/object/product-geforce-gtx-560ti-gtx-550ti-us.html</span>

<span class="n">CUDA</span> <span class="n">Cores</span>  <span class="mi">384</span>
<span class="n">Graphics</span> <span class="n">Clock</span>  <span class="p">(</span><span class="n">MHz</span><span class="p">)</span>    <span class="mi">822</span>
<span class="n">Processor</span> <span class="n">Clock</span> <span class="p">(</span><span class="n">MHz</span><span class="p">)</span>   <span class="mi">1645</span>
<span class="n">Memory</span> <span class="n">Specs</span><span class="o">:</span>   
 <span class="n">Standard</span> <span class="n">Memory</span> <span class="n">Config</span>  <span class="mi">1</span><span class="n">GB</span>
<span class="n">Feature</span> <span class="n">Support</span><span class="o">:</span>    
 <span class="n">NVIDIA</span> <span class="n">CUDA</span> <span class="n">Technology</span> 
 <span class="n">OpenGL</span>  <span class="mf">4.1</span>
</pre></div>


<h2>Install &amp; configure CUDA on Ubuntu 12.04 LTS</h2>
<p>From https://developer.nvidia.com/cuda-downloads#linux</p>
<div class="highlight"><pre><span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//developer.download.nvidia.com/compute/cuda/repos/ubuntu1204/x86_64/cuda-repo-ubuntu1204_6.0-37_amd64.deb</span>
</pre></div>


<p>From http://www.r-tutor.com/gpu-computing/cuda-installation/cuda6.0-ubuntu</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">sudo</span> <span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">cuda</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1204_6</span><span class="mf">.0</span><span class="o">-</span><span class="mi">37</span><span class="n">_amd64</span><span class="p">.</span><span class="n">deb</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">cuda</span>
</pre></div>


<p>Testing:</p>
<div class="highlight"><pre><span class="n">richarde</span><span class="err">@</span><span class="n">SV</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="mo">05</span><span class="mi">9</span><span class="o">:~</span><span class="err">$</span> <span class="n">nvcc</span> <span class="o">--</span><span class="n">version</span>
<span class="nl">nvcc:</span> <span class="n">NVIDIA</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Cuda</span> <span class="n">compiler</span> <span class="n">driver</span>
<span class="n">Built</span> <span class="n">on</span> <span class="n">Thu_Mar_13_11</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">58</span><span class="n">_PDT_2014</span>
<span class="n">Cuda</span> <span class="n">compilation</span> <span class="n">tools</span><span class="p">,</span> <span class="n">release</span> <span class="mf">6.0</span><span class="p">,</span> <span class="n">V6</span><span class="mf">.0.1</span>
</pre></div>


<p>Parenthesis: This did not work</p>
<div class="highlight"><pre><span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//developer.download.nvidia.com/compute/cuda/6_0/rel/installers/cuda_6.0.37_linux_64.run</span>
<span class="n">sudo</span> <span class="n">sh</span> <span class="n">cuda_6</span><span class="mf">.0.37</span><span class="n">_linux_64</span><span class="p">.</span><span class="n">run</span>

<span class="o">*</span> <span class="n">Please</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">your</span> <span class="n">PATH</span> <span class="n">includes</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">bin</span>
<span class="o">*</span> <span class="n">Please</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">your</span> <span class="n">LD_LIBRARY_PATH</span>
<span class="o">*</span>   <span class="n">includes</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib</span>
<span class="o">*</span> <span class="n">OR</span>
<span class="o">*</span>   <span class="n">add</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span> <span class="n">and</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib</span>
<span class="o">*</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ld</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="n">conf</span> <span class="n">and</span> <span class="n">run</span> <span class="n">ldconfig</span> <span class="n">as</span> <span class="n">root</span>

<span class="n">vim</span> <span class="p">.</span><span class="n">bashrc</span>
<span class="n">PATH</span><span class="o">=</span><span class="err">$</span><span class="n">PATH</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">bin</span>
<span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="err">$</span><span class="n">LD_LIBRARY_PATH</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib</span>
</pre></div>


<h2>Configure for Theano</h2>
<p>From http://deeplearning.net/software/theano/install.html#gpu-linux
Well, not much to configure...</p>
<p>Testing config: http://deeplearning.net/software/theano/tutorial/using_gpu.html#using-gpu</p>
<div class="highlight"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">richarde</span><span class="o">/</span><span class="n">dev</span><span class="c1">//theano</span>
<span class="n">THEANO_FLAGS</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mode</span><span class="o">=</span><span class="n">FAST_RUN</span><span class="p">,</span><span class="n">cuda</span><span class="p">.</span><span class="n">root</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">gpu</span><span class="p">,</span><span class="n">floatX</span><span class="o">=</span><span class="n">float32</span><span class="err">&#39;</span> <span class="n">python</span> <span class="n">check1</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>Woops:</p>
<div class="highlight"><pre><span class="n">ERROR</span> <span class="p">(</span><span class="n">theano</span><span class="p">.</span><span class="n">sandbox</span><span class="p">.</span><span class="n">cuda</span><span class="p">)</span><span class="o">:</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">compile</span> <span class="n">cuda_ndarray</span><span class="p">.</span><span class="n">cu</span><span class="o">:</span> <span class="n">libcublas</span><span class="p">.</span><span class="n">so</span><span class="mf">.6.0</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">open</span> <span class="n">shared</span> <span class="n">object</span> <span class="n">file</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
<span class="n">Looping</span> <span class="mi">1000</span> <span class="n">times</span> <span class="n">took</span> <span class="mf">9.06630682945</span> <span class="n">seconds</span>
<span class="n">Used</span> <span class="n">the</span> <span class="n">cpu</span>

<span class="n">sudo</span> <span class="n">ldconfig</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span>
</pre></div>


<p>Now we're good:</p>
<div class="highlight"><pre><span class="n">Using</span> <span class="n">gpu</span> <span class="n">device</span> <span class="mi">0</span><span class="o">:</span> <span class="n">GeForce</span> <span class="n">GTX</span> <span class="mi">560</span> <span class="n">Ti</span>
<span class="n">Looping</span> <span class="mi">1000</span> <span class="n">times</span> <span class="n">took</span> <span class="mf">0.494688987732</span> <span class="n">seconds</span>
<span class="n">Used</span> <span class="n">the</span> <span class="n">gpu</span>
</pre></div>


<p>Acceleration factor <code>9.0663 / 0.4946 = 18x</code>, nice!</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>